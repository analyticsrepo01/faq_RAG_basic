{"version":3,"sources":["../../src/model/middleware.ts"],"sourcesContent":["/**\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Document } from '../document.js';\nimport { ModelInfo, ModelMiddleware, Part } from '../model.js';\n\n/**\n * Preprocess a GenerateRequest to download referenced http(s) media URLs and\n * inline them as data URIs.\n */\nexport function downloadRequestMedia(options?: {\n  maxBytes?: number;\n}): ModelMiddleware {\n  return async (req, next) => {\n    const { default: fetch } = await import('node-fetch');\n\n    const newReq = {\n      ...req,\n      messages: await Promise.all(\n        req.messages.map(async (message) => {\n          const content: Part[] = await Promise.all(\n            message.content.map(async (part) => {\n              // skip non-media parts and non-http urls\n              if (!part.media || !part.media.url.startsWith('http')) {\n                return part;\n              }\n\n              const response = await fetch(part.media.url, {\n                size: options?.maxBytes,\n              });\n              if (response.status !== 200)\n                throw new Error(\n                  `HTTP error downloading media '${\n                    part.media.url\n                  }': ${await response.text()}`\n                );\n\n              // use provided contentType or sniff from response\n              const contentType =\n                part.media.contentType ||\n                response.headers.get('content-type') ||\n                '';\n\n              return {\n                media: {\n                  contentType,\n                  url: `data:${contentType};base64,${Buffer.from(\n                    await response.arrayBuffer()\n                  ).toString('base64')}`,\n                },\n              };\n            })\n          );\n\n          return {\n            ...message,\n            content,\n          };\n        })\n      ),\n    };\n\n    return next(newReq);\n  };\n}\n\n/**\n * Validates that a GenerateRequest does not include unsupported features.\n */\nexport function validateSupport(options: {\n  name: string;\n  supports?: ModelInfo['supports'];\n}): ModelMiddleware {\n  const supports = options.supports || {};\n  return async (req, next) => {\n    function invalid(message: string): never {\n      throw new Error(\n        `Model '${\n          options.name\n        }' does not support ${message}. Request: ${JSON.stringify(\n          req,\n          null,\n          2\n        )}`\n      );\n    }\n\n    if (\n      supports.media === false &&\n      req.messages.some((message) => message.content.some((part) => part.media))\n    )\n      invalid('media, but media was provided');\n    if (supports.tools === false && req.tools?.length)\n      invalid('tool use, but tools were provided');\n    if (supports.multiturn === false && req.messages.length > 1)\n      invalid(`multiple messages, but ${req.messages.length} were provided`);\n    if (\n      typeof supports.output !== 'undefined' &&\n      req.output?.format &&\n      !supports.output.includes(req.output?.format)\n    )\n      invalid(`requested output format '${req.output?.format}'`);\n    return next();\n  };\n}\n\nexport function conformOutput(): ModelMiddleware {\n  return async (req, next) => {\n    const lastMessage = req.messages[req.messages.length - 1];\n    if (\n      !req.output?.schema ||\n      req.messages\n        .at(-1)\n        ?.content.some((part) => part.metadata?.purpose === 'output')\n    ) {\n      return next(req);\n    }\n\n    lastMessage?.content.push({\n      text: `\n\nOutput should be in JSON format and conform to the following schema:\n\n\\`\\`\\`\n${JSON.stringify(req.output!.schema!)}\n\\`\\`\\`\n`,\n      metadata: { purpose: 'output', source: 'default' },\n    });\n\n    return next(req);\n  };\n}\n\n/**\n * Provide a simulated system prompt for models that don't support it natively.\n */\nexport function simulateSystemPrompt(options?: {\n  preface: string;\n  acknowledgement: string;\n}): ModelMiddleware {\n  const preface = options?.preface || 'SYSTEM INSTRUCTIONS:\\n';\n  const acknowledgement = options?.acknowledgement || 'Understood.';\n\n  return (req, next) => {\n    const messages = [...req.messages];\n    for (let i = 0; i < messages.length; i++) {\n      if (req.messages[i].role === 'system') {\n        const systemPrompt = messages[i].content;\n        messages.splice(\n          i,\n          1,\n          { role: 'user', content: [{ text: preface }, ...systemPrompt] },\n          { role: 'model', content: [{ text: acknowledgement }] }\n        );\n        break;\n      }\n    }\n    return next({ ...req, messages });\n  };\n}\n\nexport interface AugmentWithContextOptions {\n  /** Preceding text to place before the rendered context documents. */\n  preface?: string | null;\n  /** A function to render a document into a text part to be included in the message. */\n  itemTemplate?: (d: Document, options?: AugmentWithContextOptions) => string;\n  /** The metadata key to use for citation reference. Pass `null` to provide no citations. */\n  citationKey?: string | null;\n}\n\nexport const CONTEXT_PREFACE =\n  '\\n\\nUse the following information to complete your task:\\n\\n';\nconst CONTEXT_ITEM_TEMPLATE = (\n  d: Document,\n  index: number,\n  options?: AugmentWithContextOptions\n) => {\n  let out = '- ';\n  if (options?.citationKey) {\n    out += `[${d.metadata![options.citationKey]}]: `;\n  } else if (options?.citationKey === undefined) {\n    out += `[${d.metadata?.['ref'] || d.metadata?.['id'] || index}]: `;\n  }\n  out += d.text() + '\\n';\n  return out;\n};\n\nexport function augmentWithContext(\n  options?: AugmentWithContextOptions\n): ModelMiddleware {\n  const preface =\n    typeof options?.preface === 'undefined' ? CONTEXT_PREFACE : options.preface;\n  const itemTemplate = options?.itemTemplate || CONTEXT_ITEM_TEMPLATE;\n  return (req, next) => {\n    // if there is no context in the request, no-op\n    if (!req.context?.length) return next(req);\n    const userMessage = req.messages.at(-1);\n    // if there are no messages, no-op\n    if (!userMessage) return next(req);\n    // if there is already a context part, no-op\n    if (userMessage?.content.find((p) => p.metadata?.purpose === 'context'))\n      return next(req);\n    let out = `${preface || ''}`;\n    req.context?.forEach((d, i) => {\n      out += itemTemplate(new Document(d), i, options);\n    });\n    out += '\\n';\n    userMessage.content.push({ text: out, metadata: { purpose: 'context' } });\n    return next(req);\n  };\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAgBA,sBAAyB;AAOlB,SAAS,qBAAqB,SAEjB;AAClB,SAAO,CAAO,KAAK,SAAS;AAC1B,UAAM,EAAE,SAAS,MAAM,IAAI,MAAM,OAAO,YAAY;AAEpD,UAAM,SAAS,iCACV,MADU;AAAA,MAEb,UAAU,MAAM,QAAQ;AAAA,QACtB,IAAI,SAAS,IAAI,CAAO,YAAY;AAClC,gBAAM,UAAkB,MAAM,QAAQ;AAAA,YACpC,QAAQ,QAAQ,IAAI,CAAO,SAAS;AAElC,kBAAI,CAAC,KAAK,SAAS,CAAC,KAAK,MAAM,IAAI,WAAW,MAAM,GAAG;AACrD,uBAAO;AAAA,cACT;AAEA,oBAAM,WAAW,MAAM,MAAM,KAAK,MAAM,KAAK;AAAA,gBAC3C,MAAM,mCAAS;AAAA,cACjB,CAAC;AACD,kBAAI,SAAS,WAAW;AACtB,sBAAM,IAAI;AAAA,kBACR,iCACE,KAAK,MAAM,GACb,MAAM,MAAM,SAAS,KAAK,CAAC;AAAA,gBAC7B;AAGF,oBAAM,cACJ,KAAK,MAAM,eACX,SAAS,QAAQ,IAAI,cAAc,KACnC;AAEF,qBAAO;AAAA,gBACL,OAAO;AAAA,kBACL;AAAA,kBACA,KAAK,QAAQ,WAAW,WAAW,OAAO;AAAA,oBACxC,MAAM,SAAS,YAAY;AAAA,kBAC7B,EAAE,SAAS,QAAQ,CAAC;AAAA,gBACtB;AAAA,cACF;AAAA,YACF,EAAC;AAAA,UACH;AAEA,iBAAO,iCACF,UADE;AAAA,YAEL;AAAA,UACF;AAAA,QACF,EAAC;AAAA,MACH;AAAA,IACF;AAEA,WAAO,KAAK,MAAM;AAAA,EACpB;AACF;AAKO,SAAS,gBAAgB,SAGZ;AAClB,QAAM,WAAW,QAAQ,YAAY,CAAC;AACtC,SAAO,CAAO,KAAK,SAAS;AAvF9B;AAwFI,aAAS,QAAQ,SAAwB;AACvC,YAAM,IAAI;AAAA,QACR,UACE,QAAQ,IACV,sBAAsB,OAAO,cAAc,KAAK;AAAA,UAC9C;AAAA,UACA;AAAA,UACA;AAAA,QACF,CAAC;AAAA,MACH;AAAA,IACF;AAEA,QACE,SAAS,UAAU,SACnB,IAAI,SAAS,KAAK,CAAC,YAAY,QAAQ,QAAQ,KAAK,CAAC,SAAS,KAAK,KAAK,CAAC;AAEzE,cAAQ,+BAA+B;AACzC,QAAI,SAAS,UAAU,WAAS,SAAI,UAAJ,mBAAW;AACzC,cAAQ,mCAAmC;AAC7C,QAAI,SAAS,cAAc,SAAS,IAAI,SAAS,SAAS;AACxD,cAAQ,0BAA0B,IAAI,SAAS,MAAM,gBAAgB;AACvE,QACE,OAAO,SAAS,WAAW,iBAC3B,SAAI,WAAJ,mBAAY,WACZ,CAAC,SAAS,OAAO,UAAS,SAAI,WAAJ,mBAAY,MAAM;AAE5C,cAAQ,6BAA4B,SAAI,WAAJ,mBAAY,MAAM,GAAG;AAC3D,WAAO,KAAK;AAAA,EACd;AACF;AAEO,SAAS,gBAAiC;AAC/C,SAAO,CAAO,KAAK,SAAS;AAxH9B;AAyHI,UAAM,cAAc,IAAI,SAAS,IAAI,SAAS,SAAS,CAAC;AACxD,QACE,GAAC,SAAI,WAAJ,mBAAY,aACb,SAAI,SACD,GAAG,EAAE,MADR,mBAEI,QAAQ,KAAK,CAAC,SAAM;AA9H9B,UAAAA;AA8HiC,eAAAA,MAAA,KAAK,aAAL,gBAAAA,IAAe,aAAY;AAAA,SACtD;AACA,aAAO,KAAK,GAAG;AAAA,IACjB;AAEA,+CAAa,QAAQ,KAAK;AAAA,MACxB,MAAM;AAAA;AAAA;AAAA;AAAA;AAAA,EAKV,KAAK,UAAU,IAAI,OAAQ,MAAO,CAAC;AAAA;AAAA;AAAA,MAG/B,UAAU,EAAE,SAAS,UAAU,QAAQ,UAAU;AAAA,IACnD;AAEA,WAAO,KAAK,GAAG;AAAA,EACjB;AACF;AAKO,SAAS,qBAAqB,SAGjB;AAClB,QAAM,WAAU,mCAAS,YAAW;AACpC,QAAM,mBAAkB,mCAAS,oBAAmB;AAEpD,SAAO,CAAC,KAAK,SAAS;AACpB,UAAM,WAAW,CAAC,GAAG,IAAI,QAAQ;AACjC,aAAS,IAAI,GAAG,IAAI,SAAS,QAAQ,KAAK;AACxC,UAAI,IAAI,SAAS,CAAC,EAAE,SAAS,UAAU;AACrC,cAAM,eAAe,SAAS,CAAC,EAAE;AACjC,iBAAS;AAAA,UACP;AAAA,UACA;AAAA,UACA,EAAE,MAAM,QAAQ,SAAS,CAAC,EAAE,MAAM,QAAQ,GAAG,GAAG,YAAY,EAAE;AAAA,UAC9D,EAAE,MAAM,SAAS,SAAS,CAAC,EAAE,MAAM,gBAAgB,CAAC,EAAE;AAAA,QACxD;AACA;AAAA,MACF;AAAA,IACF;AACA,WAAO,KAAK,iCAAK,MAAL,EAAU,SAAS,EAAC;AAAA,EAClC;AACF;AAWO,MAAM,kBACX;AACF,MAAM,wBAAwB,CAC5B,GACA,OACA,YACG;AA9LL;AA+LE,MAAI,MAAM;AACV,MAAI,mCAAS,aAAa;AACxB,WAAO,IAAI,EAAE,SAAU,QAAQ,WAAW,CAAC;AAAA,EAC7C,YAAW,mCAAS,iBAAgB,QAAW;AAC7C,WAAO,MAAI,OAAE,aAAF,mBAAa,aAAU,OAAE,aAAF,mBAAa,UAAS,KAAK;AAAA,EAC/D;AACA,SAAO,EAAE,KAAK,IAAI;AAClB,SAAO;AACT;AAEO,SAAS,mBACd,SACiB;AACjB,QAAM,UACJ,QAAO,mCAAS,aAAY,cAAc,kBAAkB,QAAQ;AACtE,QAAM,gBAAe,mCAAS,iBAAgB;AAC9C,SAAO,CAAC,KAAK,SAAS;AA/MxB;AAiNI,QAAI,GAAC,SAAI,YAAJ,mBAAa;AAAQ,aAAO,KAAK,GAAG;AACzC,UAAM,cAAc,IAAI,SAAS,GAAG,EAAE;AAEtC,QAAI,CAAC;AAAa,aAAO,KAAK,GAAG;AAEjC,QAAI,2CAAa,QAAQ,KAAK,CAAC,MAAG;AAtNtC,UAAAA;AAsNyC,eAAAA,MAAA,EAAE,aAAF,gBAAAA,IAAY,aAAY;AAAA;AAC3D,aAAO,KAAK,GAAG;AACjB,QAAI,MAAM,GAAG,WAAW,EAAE;AAC1B,cAAI,YAAJ,mBAAa,QAAQ,CAAC,GAAG,MAAM;AAC7B,aAAO,aAAa,IAAI,yBAAS,CAAC,GAAG,GAAG,OAAO;AAAA,IACjD;AACA,WAAO;AACP,gBAAY,QAAQ,KAAK,EAAE,MAAM,KAAK,UAAU,EAAE,SAAS,UAAU,EAAE,CAAC;AACxE,WAAO,KAAK,GAAG;AAAA,EACjB;AACF;","names":["_a"]}